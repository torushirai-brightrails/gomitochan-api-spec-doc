import asyncio
import logging
import os
from langchain_openai import ChatOpenAI
from utcp_agent import UtcpAgent

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s [%(levelname)s] %(name)s:%(lineno)d - %(message)s',
    handlers=[
        logging.StreamHandler(sys.stdout)
    ]
)

# Disable UTCP library logging
logging.getLogger("utcp").setLevel(logging.WARNING)

async def main():
    # OpenAI API„Ç≠„Éº„ÇíÁí∞Â¢ÉÂ§âÊï∞„Åã„ÇâÂèñÂæó
    llm = ChatOpenAI(
        model="gpt-5-nano",
        api_key=os.getenv("OPENAI_API_KEY")
    )
    
    # UTCP„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÅÆ‰ΩúÊàê
    agent = await UtcpAgent.create(
        llm=llm,
        utcp_config={
            "manual_call_templates": [{
                "name": "getGarbageItemsByCity",
                "call_template_type": "http",
                "http_method": "GET",
                "url": "https://api-gateway.gomitochan.net/v1/utcp",
                "content_type": "application/json"
            }],
            "variables": {
                "getGarbageItemsByCity_API_KEY": os.getenv("GOMITOCHAN_API_KEY")
            }
        }
    )

    print("üß† UTCP Agent ready. Type 'exit' to quit.")
    while True:
        user_input = input("You: ").strip()
        if user_input.lower() in ["exit", "quit", "q"]:
            print("üëã ÁµÇ‰∫Ü„Åó„Åæ„Åô„ÄÇ")
            break
        try:
            user_prompt = "„ÅÇ„Å™„Åü„ÅØ„ÄÅ„Åî„Åø„Å´Èñ¢„Åô„Çã„Åì„Å®„ÄÅ„Åî„Åø„Å´‰º¥„ÅÜÁí∞Â¢É„Å∏„ÅÆÂΩ±Èüø„ÇÑË≤¢ÁåÆ„ÄÅ„Åî„ÅøÂá∫„Åó„ÄÅ„Åî„ÅøÂàÜÂà•„ÄÅ„Åî„ÅøÂΩìÁï™„Å´Èñ¢„Åô„ÇãÂïè„ÅÑÂêà„Çè„Åõ„ÅÆ„ÅøËøîÁ≠î„Åô„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ„Åù„Çå‰ª•Â§ñ„ÅÆÂïè„ÅÑÂêà„Çè„Åõ„ÅØÂØæÂøú„Åß„Åç„Å™„ÅÑ„ÅÆ„Åß„ÄÅ„ÅäÊñ≠„Çä„ÅÆËøîÁ≠î„Çí„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰ª•Èôç„ÅåÂïè„ÅÑÂêà„Çè„Åõ„ÅÆÂÜÖÂÆπ„Å´„Å™„Çä„Åæ„Åô„ÄÇ=> "
            response = await agent.chat(f"{user_prompt}{user_input}")
            print(f"Agent: {response}")
        except Exception as e:
            print(f"‚ö†Ô∏è „Ç®„É©„Éº: {e}")

if __name__ == "__main__":
    asyncio.run(main())