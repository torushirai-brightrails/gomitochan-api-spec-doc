"""
sample_mcp_agent_anthropic.py
Reference: https://code.claude.com/docs/en/mcp

"""

"""
Basic Anthropic Claude example for MCPAgent.

This example demonstrates how to use MCPAgent with Anthropic Claude models.
"""

import sys, os
import logging
import asyncio
import httpx
from contextlib import AsyncExitStack
from anthropic import Anthropic

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(name)s:%(lineno)d - %(message)s",
    handlers=[logging.StreamHandler(sys.stdout)],
)

# Disable httpx library logging
logging.getLogger("httpx").setLevel(logging.WARNING)

MCP_SERVER_URL = "https://api-gateway.gomitochan.net/agentapi/v1/mcp"


class AnthropicMCPClient:

    def __init__(self):
        self.exit_stack = AsyncExitStack()
        self.anthropic = Anthropic(api_key=os.getenv("ANTHROPIC_API_KEY"))
        self.http_client = None
        self.tools = []

    def convert_mcp_tool_to_anthropic(self, mcp_tool):
        """Convert MCP tool definitions to Anthropic API format"""
        return {
            "name": mcp_tool.get("name"),
            "description": mcp_tool.get("description", ""),
            "input_schema": mcp_tool.get("inputSchema", {}),
        }

    async def connect_to_server(self):
        """Connect to the MCP server via an HTTP endpoint"""
        self.http_client = httpx.AsyncClient(
            headers={
                "X-Api-Key": os.getenv("GOMITOCHAN_API_KEY"),
                "Content-Type": "application/json",
            },
            timeout=30.0,
        )

        # Get the tool list
        try:
            response = await self.http_client.post(
                MCP_SERVER_URL, json={"jsonrpc": "2.0", "id": 1, "method": "tools/list"}
            )
            response.raise_for_status()
            data = response.json()

            if "result" in data and "tools" in data["result"]:
                mcp_tools = data["result"]["tools"]

                # Convert MCP tools to Anthropic format
                self.tools = [
                    self.convert_mcp_tool_to_anthropic(tool) for tool in mcp_tools
                ]

                for tool in self.tools:
                    logging.debug(
                        f"  - {tool.get('name', 'unknown')}: {tool.get('description', '')}"
                    )
            else:
                logging.warning("âš ï¸ Warning: The tool could not be retrieved.")

        except Exception as e:
            logging.error(f"âš ï¸ Error: Server connection error: {e}")
            raise

    async def call_tool(self, tool_name: str, tool_input: dict):
        """Call the MCP server tool"""
        try:
            response = await self.http_client.post(
                MCP_SERVER_URL,
                json={
                    "jsonrpc": "2.0",
                    "id": 2,
                    "method": "tools/call",
                    "params": {"name": tool_name, "arguments": tool_input},
                },
            )
            response.raise_for_status()
            data = response.json()

            if "result" in data:
                return data["result"]
            elif "error" in data:
                return {"error": data["error"]}
            else:
                return {"error": "Unexpected response format"}

        except Exception as e:
            return {"error": str(e)}

    async def process_query(self, query: str):
        """Process the query and retrieve the response from Claude"""
        messages = [{"role": "user", "content": query}]

        instructions = "ã‚ãªãŸã¯ã€ã”ã¿ã«é–¢ã™ã‚‹ã“ã¨ã€ã”ã¿ã«ä¼´ã†ç’°å¢ƒã¸ã®å½±éŸ¿ã‚„è²¢çŒ®ã€ã”ã¿å‡ºã—ã€ã”ã¿åˆ†åˆ¥ã€ã”ã¿å½“ç•ªã«é–¢ã™ã‚‹å•ã„åˆã‚ã›ã®ã¿è¿”ç­”ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãã‚Œä»¥å¤–ã®å•ã„åˆã‚ã›ã¯å¯¾å¿œã§ããªã„ã®ã§ã€ãŠæ–­ã‚Šã®è¿”ç­”ã‚’ã—ã¦ãã ã•ã„ã€‚"

        # If no tool is available, process it as a normal conversation.
        if not self.tools:
            logging.warning("âš ï¸ Warning: The tool is unavailable.")
            return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ç¾åœ¨ãƒ„ãƒ¼ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚"

        # Contact Claude
        response = self.anthropic.messages.create(
            model="claude-sonnet-4-5-20250929",
            max_tokens=1024,
            system=instructions,
            messages=messages,
            tools=self.tools,
        )

        # Tool usage loop processing
        while response.stop_reason == "tool_use":
            # Process tool calls
            tool_results = []

            for block in response.content:
                if block.type == "tool_use":
                    # Run the tool
                    result = await self.call_tool(block.name, block.input)
                    tool_results.append(
                        {
                            "type": "tool_result",
                            "tool_use_id": block.id,
                            "content": str(result),
                        }
                    )

            # Update message history
            messages.append({"role": "assistant", "content": response.content})
            messages.append({"role": "user", "content": tool_results})

            # Contact Claude again
            response = self.anthropic.messages.create(
                model="claude-sonnet-4-5-20250929",
                max_tokens=1024,
                system=instructions,
                messages=messages,
                tools=self.tools,
            )

        # Extract the final text response
        final_response = ""
        for block in response.content:
            if hasattr(block, "text"):
                final_response += block.text

        return final_response

    async def chat_loop(self):
        """Interactive Chat Loop"""
        print("=== McpAgent with Anthropic ===")
        print("ğŸ§  MCP Agent ready. Type 'exit' to quit.")
        try:
            while True:
                try:
                    user_input = input("You: ").strip()
                    if not user_input:
                        continue
                    elif user_input.lower() in ["exit", "quit", "q"]:
                        print("ğŸ‘‹ çµ‚äº†ã—ã¾ã™ã€‚")
                        break

                    assistant_message = await self.process_query(user_input)
                    print(f"Agent: {assistant_message}\n")

                except KeyboardInterrupt:
                    print("ğŸ‘‹ çµ‚äº†ã—ã¾ã™ã€‚")
                    break
        except Exception as e:
            print(f"âš ï¸ ã‚¨ãƒ©ãƒ¼: {e}")

    async def cleanup(self):
        """Resource Cleanup"""
        if self.http_client:
            await self.http_client.aclose()
        await self.exit_stack.aclose()


async def main():
    """Example using Anthropic Claude models."""
    client = AnthropicMCPClient()

    try:
        # Connect to the server
        await client.connect_to_server()

        # Start a chat loop
        await client.chat_loop()

    finally:
        # Cleanup
        await client.cleanup()


if __name__ == "__main__":
    asyncio.run(main())
