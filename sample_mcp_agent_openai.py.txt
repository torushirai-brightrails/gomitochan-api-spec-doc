"""
Reference: https://platform.openai.com/docs/guides/tools-connectors-mcp
"""

"""
Basic OpenAI GPT example for MCPAgent.

This example demonstrates how to use MCPAgent with OpenAI GPT models.
"""

import sys, os
import logging
import asyncio
from openai import OpenAI

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(name)s:%(lineno)d - %(message)s",
    handlers=[logging.StreamHandler(sys.stdout)],
)

# Disable httpx library logging
logging.getLogger("httpx").setLevel(logging.WARNING)


async def main():
    """Example using OpenAI GPT models."""
    print("=== McpAgent with OpenAI ===")

    # Create an MCP Agent
    OpenAI.api_key = os.getenv("OPENAI_API_KEY")
    client = OpenAI()

    # Retain conversation history
    conversation_history = []
    # Compile conversation history as a string
    conversation_text = ""

    print("ğŸ§  MCP Agent ready. Type 'exit' to quit.")
    try:
        while True:
            try:
                conv_id = None

                # User Input
                user_input = input("You: ").strip()
                if not user_input:
                    continue
                elif user_input.lower() in ["exit", "quit", "q"]:
                    print("ğŸ‘‹ çµ‚äº†ã—ã¾ã™ã€‚")
                    break

                # Manage conversation history as text strings
                conversation_text += f"\nYou: {user_input}"

                conversation_history.append({"role": "user", "content": user_input})

                # OpenAI Responses API call
                resp = client.responses.create(
                    model="gpt-5-nano",
                    instructions=(
                        "ã‚ãªãŸã¯ã€ã”ã¿ã«é–¢ã™ã‚‹ã“ã¨ã€ã”ã¿ã«ä¼´ã†ç’°å¢ƒã¸ã®å½±éŸ¿ã‚„è²¢çŒ®ã€ã”ã¿å‡ºã—ã€ã”ã¿åˆ†åˆ¥ã€ã”ã¿å½“ç•ªã«é–¢ã™ã‚‹å•ã„åˆã‚ã›ã®ã¿è¿”ç­”ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãã‚Œä»¥å¤–ã®å•ã„åˆã‚ã›ã¯å¯¾å¿œã§ããªã„ã®ã§ã€ãŠæ–­ã‚Šã®è¿”ç­”ã‚’ã—ã¦ãã ã•ã„ã€‚"
                    ),
                    tools=[
                        {
                            "type": "mcp",
                            "server_label": "gomitochan-mcp-server",
                            "server_description": "ã”ã¿å½“ã¡ã‚ƒã‚“ãŒæä¾›ã™ã‚‹è‡ªæ²»ä½“åˆ¥ã”ã¿åˆ†åˆ¥æ¤œç´¢",
                            "server_url": "https://api-gateway.gomitochan.net/agentapi/v1/mcp",
                            "require_approval": "never",
                            "allowed_tools": ["getGarbageItemsByCity"],
                            "headers": {"X-Api-Key": os.getenv("GOMITOCHAN_API_KEY")},
                        },
                    ],
                    input=user_input,
                    previous_response_id=conv_id,
                )

                # Get conversation ID
                conv_id = resp.id

                # Model response
                assistant_message = resp.output_text
                print(f"Agent: {assistant_message}\n")

                # Add to history
                conversation_history.append(
                    {"role": "assistant", "content": assistant_message}
                )
            except KeyboardInterrupt:
                print("ğŸ‘‹ çµ‚äº†ã—ã¾ã™ã€‚")
                break
    except Exception as e:
        print(f"âš ï¸ ã‚¨ãƒ©ãƒ¼: {e}")


if __name__ == "__main__":
    asyncio.run(main())
